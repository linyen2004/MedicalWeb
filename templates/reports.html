{% extends "base.html" %}
{% block content %}
<h2>Reports</h2>

{% if is_doctor %}
    <h3>All Patients</h3>
    {% for patient, data in reports.items() %}
        <div class="card">
            <h4>{{ patient }}</h4>

            <!-- Modules -->
            <p><strong>Modules:</strong></p>
            {% if data.modules %}
                <ul>
                {% for m in data.modules %}
                    <li>{{ m }}</li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No modules assigned</p>
            {% endif %}

            <!-- Latest Metrics -->
            <p><strong>Latest Metrics:</strong> {{ data.metrics }}</p>
            <p><strong>Last Log:</strong> {{ data.last_log }}</p>

            <!-- Logs (可編輯) -->
            <p><strong>Logs:</strong></p>
            {% if data.logs %}
                <ul>
                {% for log in data.logs %}
                    <li>
                        {{ log }}
                        <details style="display:inline-block; margin-left:10px;">
                            <summary class="btn small">Edit</summary>
                            <form action="/edit_log/{{ patient }}/{{ loop.index0 }}" method="post" style="display:inline-block; margin-left:8px;">
                                <input type="text" name="new_text" value="{{ log }}" required>
                                <button type="submit" class="btn small">Save</button>
                            </form>
                        </details>
                        <form action="/delete_log/{{ patient }}/{{ loop.index0 }}" method="post" style="display:inline-block; margin-left:6px;">
                            <button type="submit" class="btn small" onclick="return confirm('Delete this log?')">Delete</button>
                        </form>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No logs recorded</p>
            {% endif %}

            <!-- Add Log -->
            <details>
                <summary class="btn">➕ Add Log</summary>
                <form action="/add_log/{{ patient }}" method="post" class="form">
                    <label>Log text</label>
                    <input type="text" name="log_text" required>
                    <button type="submit" class="btn">Submit</button>
                </form>
            </details>

            <!-- History -->
            <p><strong>History:</strong></p>
            {% if data.history %}
                <ul>
                {% for h in data.history %}
                    <li>{{ h.timestamp }} - {{ h.summary }}</li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No history</p>
            {% endif %}
        </div>
    {% endfor %}

{% else %}
    <h3>Your Report</h3>
    {% for patient, data in reports.items() %}
        <div class="card">
            <h4>{{ patient }}</h4>

            <!-- Modules -->
            <p><strong>Modules:</strong></p>
            {% if data.modules %}
                <ul>
                {% for m in data.modules %}
                    <li>{{ m }}</li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No modules assigned</p>
            {% endif %}

            <!-- Latest Metrics -->
            <p><strong>Latest Metrics:</strong> {{ data.metrics }}</p>
            <p><strong>Last Log:</strong> {{ data.last_log }}</p>

            <!-- Logs (可編輯) -->
            <p><strong>Logs:</strong></p>
            {% if data.logs %}
                <ul>
                {% for log in data.logs %}
                    <li>
                        {{ log }}
                        <details style="display:inline-block; margin-left:10px;">
                            <summary class="btn small">Edit</summary>
                            <form action="/edit_log/{{ patient }}/{{ loop.index0 }}" method="post" style="display:inline-block; margin-left:8px;">
                                <input type="text" name="new_text" value="{{ log }}" required>
                                <button type="submit" class="btn small">Save</button>
                            </form>
                        </details>
                        <form action="/delete_log/{{ patient }}/{{ loop.index0 }}" method="post" style="display:inline-block; margin-left:6px;">
                            <button type="submit" class="btn small" onclick="return confirm('Delete this log?')">Delete</button>
                        </form>
                    </li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No logs recorded</p>
            {% endif %}

            <!-- Add Log -->
            <details>
                <summary class="btn">➕ Add Log</summary>
                <form action="/add_log/{{ patient }}" method="post" class="form">
                    <label>Log text</label>
                    <input type="text" name="log_text" required>
                    <button type="submit" class="btn">Submit</button>
                </form>
            </details>

            <!-- History -->
            <p><strong>History:</strong></p>
            {% if data.history %}
                <ul>
                {% for h in data.history %}
                    <li>{{ h.timestamp }} - {{ h.summary }}</li>
                {% endfor %}
                </ul>
            {% else %}
                <p>No history</p>
            {% endif %}
        </div>
    {% endfor %}
{% endif %}
{% endblock %}
